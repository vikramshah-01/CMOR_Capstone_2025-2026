<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Page</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="three-column-layout">
    <h1>Simulate Clinical Conditions</h1>
    <p>This page allows you to simulate common clinical conditions in Fontan patients. The adjustable parameters reflect physiological factors that can be influenced by clinical interventions such as milrinone, epinephrine, and vasodilators. After making any desired adjustments, click Submit. The resulting table compares patient vitals with and without the selected condition, helping to visualize the physiological effects of common clinical conditions more clearly.</p>

    <!--Buttons for Preset Conditions-->
    <div class="button-container">
        <button class="preset-btn" onclick="setVitalsAndApply('lowPreload')">Low Preload</button>
        <button class="preset-btn" onclick="setVitalsAndApply('lungProblem')">Pulmonary Disease</button>
        <button class="preset-btn" onclick="setVitalsAndApply('heartFailure')">Heart Failure</button>
    </div>

    <!-- Embedded Image -->
    <div class="flex-container">
        <div class="left-column">
            <img src="/static/new_fontan_diagram.png" usemap="#image-map" alt="Patient Vitals Diagram" class="interactive-image" id="clickable-image">

            <!-- Image Map Generated by http://www.image-map.net/ -->
            <map name="image-map">
                <area target="" alt="Upper Body" title="Upper Body" href="" coords="554,176,566,139,585,122,598,119,586,103,584,89,590,84,587,60,592,47,601,30,618,22,642,22,661,31,675,45,680,62,676,82,684,89,677,107,668,119,687,126,703,154,709,177,668,186,633,190,591,185" shape="poly"
                data-content="Upper Body: Includes the head, neck, and arms.">
                
                <area target="" alt="Lower Body" title="Lower Body" href="" coords="537,917,636,917,631,940,641,972,644,1006,649,1020,646,1039,629,1090,624,1097,629,1123,618,1134,606,1126,601,1091,603,1084,604,1061,613,1030,601,1016,596,999,591,982,582,983,569,1013,560,1028,570,1054,571,1071,571,1085,576,1093,566,1107,563,1118,556,1126,540,1121,545,1099,550,1089,534,1066,526,1046,526,1016,532,1006,526,991,534,960,541,933" shape="poly"
                data-content="Lower Body: Includes the abdomen, lower back, and lower extremities.">
                
                <area target="" alt="Right Lung" title="Right Lung" href="" coords="232,401,195,450,169,494,159,526,156,542,151,575,146,610,149,637,162,640,178,631,202,620,241,610,259,597,265,577,266,533,269,511,262,477,256,462,259,442,251,415,246,403" shape="poly"
                data-content="Right Lung: Responsible for gas exchange, allowing oxygen to enter the blood and carbon dioxide to exit.">
                
                <area target="" alt="Left Lung" title="Left Lung" href="" coords="922,369,948,391,982,425,999,463,1010,497,1013,515,1025,590,1021,628,1013,629,997,610,975,598,955,590,930,593,917,581,899,571,906,544,908,514,896,477,895,443,900,401,906,376" shape="poly"
                data-content="Left Lung: Responsible for gas exchange, allowing oxygen to enter the blood and carbon dioxide to exit.">
                
                <area target="" alt="Aortic Arch Branches" title="Aortic Arch Branches" href="" coords="599,446,606,420,626,395,648,369,675,333,695,297,712,258,720,226,722,197,720,178,712,158,703,147,712,176,699,182,676,187,686,205,687,227,686,251,678,276,660,312,635,349,593,399,578,425,570,455,554,414,541,415,551,464,581,454,601,458" shape="poly"
                data-content="Aortic Arch Branches: Supply blood to head, neck, and arms.">
                
                <area target="" alt="Superior Vena Cava" title="Superior Vena Cava" href="" coords="569,135,554,177,574,180,557,191,549,203,537,223,529,255,525,285,522,325,524,366,529,411,535,440,547,436,550,452,541,467,538,484,520,485,510,478,514,455,507,420,513,411,508,373,504,331,504,265,508,224,517,195,528,166,544,145" shape="poly"
                data-content="Superior vena cava (SVC): Delivers deoxygenated blood from the upper body to the pulmonary artery.">
                
                <area target="" alt="Right Pulmonary Artery" title="Right Pulmonary Artery" href="" coords="483,479,421,469,361,466,316,466,260,475,269,503,291,495,322,489,355,486,401,487,445,492,486,495" shape="poly"
                data-content="Right Pulmonary Artery: Delivers deoxygenated blood from the body to the right lung.">
                
                <area target="" alt="Right Pulmonary Vein" title="Right Pulmonary Vein" href="" coords="267,534,266,565,292,566,330,562,368,555,407,547,444,537,481,525,494,500,465,509,437,518,403,526,375,533,346,537,319,539,296,539" shape="poly"
                data-content="Right Pulmonary Vein: Delivers oxygenated blood from the right lung back to the heart.">
                
                <area target="" alt="Descending Aorta" title="Descending Aorta" href="" coords="612,714,626,714,634,763,637,805,639,855,636,889,632,916,600,916,615,888,622,856,624,819,619,758" shape="poly"
                data-content="Descending Aorta: Delivers oxygenated blood to the chest, abdomen, lower back, and legs.">
                
                <area target="" alt="Inferior Vena Cava" title="Inferior Vena Cava" href="" coords="518,672,520,687,517,709,519,745,522,785,528,829,538,870,553,898,568,915,533,917,520,887,512,857,507,825,502,767,500,710,493,702,490,665,503,665,514,660" shape="poly"
                data-content="Inferior Vena Cava (IVC): Delivers deoxygenated blood from the lower body to the pulmonary artery.">
                
                <area target="" alt="Left Pulmonary Artery" title="Left Pulmonary Artery" href="" coords="670,498,649,492,659,493,682,492,717,486,776,481,811,481,846,482,886,491,904,504,896,477,896,464,862,461,831,458,798,459,757,462,715,466,644,476,620,493,594,496,569,492,567,508,567,513,598,519,643,510,663,511" shape="poly"
                data-content="Left Pulmonary Artery: Delivers deoxygenated blood from the body to the left lung.">

                <area target="" alt="Left Pulmonary Vein" title="Left Pulmonary Vein" href="" coords="623,526,647,539,662,551,715,559,754,565,794,568,836,568,878,561,902,554,906,529,905,509,886,527,860,536,832,542,796,543,760,542,714,537,688,533,668,527,660,514" shape="poly"
                data-content="Left Pulmonary Vein: Delivers oxygenated blood from the left lung back to the heart.">
                
                <area target="" alt="Heart" title="Heart" href="" coords="517,668,555,690,590,704,632,713,659,710,678,692,684,670,683,632,672,591,658,564,652,545,631,530,606,524,585,524,571,524,580,549,562,546,553,551,549,561,541,539,537,531,525,529,507,534,498,569,497,599,505,631" shape="poly"
                data-content="Fontan Heart: The heart is reconfigured so that blood can bypass the left side of the heart by directly connecting the IVC and SVC to the pulmonary artery, allowing the right ventricle to take over as the main pumping chamber.">
                
                <area target="" alt="Ascending Aorta" title="Ascending Aorta" href="" coords="549,557,559,545,578,548,567,497,540,489,537,515,540,537" shape="poly"
                data-content="Ascending Aorta: Upward curve that occurs shortly after the aorta leaves the heart.">
                
                <area target="" alt="Aortic Arch" title="Aortic Arch" href="" coords="549,465,540,487,566,494,575,484,585,482,596,488,599,495,621,491,616,472,606,459,582,454" shape="poly"
                data-content="Aortic Arch: Curved segment that gives the aorta its cane-like shape. It bridges the ascending and descending aorta.">
                
                <area target="" alt="Inferior Vena Cava" title="Inferior Vena Cava" href="" coords="504,495,486,517,501,517,510,529,522,516,530,503,521,493,512,489" shape="poly"
                data-content="Inferior Vena Cava (IVC): Delivers deoxygenated blood from the lower body to the pulmonary artery.">
                
                <area target="" alt="Fontan Conduit" title="Fontan Conduit" href="" coords="486,519,500,519,507,529,500,554,498,583,499,618,504,636,513,660,503,664,492,663,476,634,469,596,470,554" shape="poly"
                data-content="Fontan Conduit: Tube that connects the IVC to the pulmonary artery.">
                
                <area target="" alt="Descending Aorta" title="Descending Aorta" href="" coords="598,522,619,526,622,518,609,518" shape="poly"
                data-content="Descending Aorta: Delivers oxygenated blood to the chest, abdomen, lower back, and legs.">
                
                <area target="" alt="Right Pulmonary Vein" title="Right Pulmonary Vein" href="" coords="526,513,512,529,536,528,536,516" shape="poly"
                data-content="Right Pulmonary Vein: Delivers oxygenated blood from the right lung back to the heart.">
            </map>
        </div>
        
        <!-- Sliders -->
        <div class="middle-column">
            <div class="card">
                <h2>Adjust Parameters</h2>
                <form id="parameterForm">
                <!-- Heart Rate -->
                <label for="HR">Heart Rate (beats/min):</label>
                <input type="number" id="HR" name="HR"
                        min="50" max="150" step="1" value="100" required>
                <br><br>

                <!-- UVR -->
                <label for="UVR">Upper Vascular Resistance (Wood Units):</label>
                <input type="number" id="UVR" name="UVR"
                        min="30" max="60" step="1" value="45" required>
                <br><br>

                <!-- LVR -->
                <label for="LVR">Lower Vascular Resistance (Wood Units):</label>
                <input type="number" id="LVR" name="LVR"
                        min="20" max="50" step="1" value="35" required>
                <br><br>

                <!-- PVR -->
                <label for="PVR">Pulmonary Vascular Resistance (Wood Units):</label>
                <input type="number" id="PVR" name="PVR"
                        min="5" max="45" step="1" value="10" required>
                <br><br>

                <!-- S_sa -->
                <label for="S_sa">Systemic Artery Saturation (fraction, 0.98–1.00):</label>
                <input type="number" id="S_sa" name="S_sa"
                        min="0.98" max="1" step="0.01" value="0.99" required>
                <br><br>

                <!-- Hb -->
                <label for="Hb">Hemoglobin (g/dL):</label>
                <input type="number" id="Hb" name="Hb"
                        min="7" max="22" step="0.1" value="15" required>
                <br><br>

                <!-- CVO2u -->
                <label for="CVO2u">Oxygen Consumption of the Upper Body (mL O₂/min):</label>
                <input type="number" id="CVO2u" name="CVO2u"
                        min="35" max="105" step="1" value="70" required>
                <br><br>

                <!-- CVO2l -->
                <label for="CVO2l">Oxygen Consumption of the Lower Body (mL O₂/min):</label>
                <input type="number" id="CVO2l" name="CVO2l"
                        min="25" max="75" step="1" value="50" required>
                <br><br>

                <div class="action-buttons" style="margin-top: 20px; text-align: center;">
                    <button type="submit">Submit</button>
                </div>
                </form>
            </div>
        </div>

        <div class="right-column">
            <!-- Result table goes here -->
            <p id="result"></p>
            <div id="conditionResults"></div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span id="modal-close" class="close">&times;</span>
            <p id="modal-text">Preset applied successfully!</p>
        </div>
    </div>

    <!-- Add Diagram Pop-up Modals -->
    <div id="popup-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span id="diagram-close" class="close">&times;</span>
            <p id="diagram-text"></p>
        </div>
    </div>   
    

    <!-- Back to Home goes under the table -->
    <div style="text-align: center; margin-top: 30px;">
        <a href="/"><button>Back to Home</button></a>
    </div>


    <!-- EXTERNAL SCRIPTS -->
    <script src="/static/script.js"></script>

    <!-- Install ImageMapResizer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/image-map-resizer/1.0.10/js/imageMapResizer.min.js"></script>

    <!-- Initialize the Resizer -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const image = document.getElementById('clickable-image');
            image.style.width = '100%'; // reduce size
            image.style.height = 'auto'; // Maintain aspect ratio

            imageMapResize(); // Resizes all image maps on the page
        });
    </script>

    <!-- Enables interactivity with the <area> elements in the map-->
    <script>
        // Example of an interaction when clicking an area
        document.querySelectorAll('area').forEach((area) => {
            area.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent navigation (if href is empty)
            });
        });
    </script>

    <!-- sets conditions-->
    <script>
        function setVitalsAndApply(condition) {
            setVitals(condition); // update sliders immediately
            applyPreset(condition); // send request to Flask backend
            showConfirmationModal(condition)
            highlightSelectedButton(condition);
        }

        function setVitals(condition) {
            const vitals = {
                // all pressures should be low, including fontan and common atrium
                // FONTAN PRESSURE = PULMONARY ARTERY PRESSURE
                // CA PRESSURE = PULMONARY VEIN PRESSURE
                // translate low volume into the last pressure equation, whcih should lower the pressures, (x10/9 for all compliances), but should i do so for C_s and C_d (no)
                lowPreload: {
                    HR: 100,
                    UVR: 45,
                    LVR: 35,
                    PVR: 10,
                    S_sa: 0.99,
                    Hb: 15,
                    CVO2u: 70,
                    CVO2l: 50
                },
                // fontan pressure is high
                // common atrium pressure is low
                // PVR can double, DONE
                lungProblem: {
                    HR: 100,
                    UVR: 45,
                    LVR: 35,
                    PVR: 27,
                    S_sa: 0.99,
                    Hb: 15,
                    CVO2u: 70,
                    CVO2l: 50
                },
                // all pressures will be high - lower all compliances except C_s (x0.9, x(10/9)
                // SHOULD SEE SMALLER CARDIAC OUTPUT - systolic and diastolic heart failure, keep other compliances the same
                // raise systolic compliance for the heart or decrease diastolic
                heartFailure: {
                    HR: 100,
                    UVR: 45,
                    LVR: 35,
                    PVR: 10,
                    S_sa: 0.99,
                    Hb: 15,
                    CVO2u: 70,
                    CVO2l: 50
                }
            };
    
            const selectedVitals = vitals[condition];
    
            // Update each slider and display the value immediately (frontend)
            for (const key in selectedVitals) {
                if (document.getElementById(key)) {
                    document.getElementById(key).value = selectedVitals[key];
                    document.getElementById(key + "Value").innerText = selectedVitals[key];
                }
            }

                // Now handle PVR disabling logic
                const pvrSlider = document.getElementById("PVR");

                if (condition === 'lungProblem') {
                    pvrSlider.disabled = true; // disable slider
                    pvrSlider.classList.add('disabled-slider'); // Optional: add visual cue
                } else {
                    pvrSlider.disabled = false; // re-enable slider
                    pvrSlider.classList.remove('disabled-slider'); // Remove visual cue if present
                }
            }

        function applyPreset(condition) {
            fetch(`/apply_preset?condition=${condition}`)
            .then(response => response.json())
            .then(data => {
                console.log("Backend Response:", data);

                // updates sliders again with backend confirmed values
                for (const key in data) {
                    if (document.getElementById(key)) {
                        document.getElementById(key).value = data[key];
                        document.getElementById(key + "Value").innerText = data[key];
                    }
                }
                console.log("updated from backend:", data)
                showConfirmationModal(condition);
            })
            .catch(error => console.error("Error applying preset:", error));
        }

        function highlightSelectedButton(condition) {
            document.querySelectorAll('.preset-btn').forEach(btn => {
                if (btn.getAttribute('onclick')?.includes(condition)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }
    </script>    
</body>
</html>
